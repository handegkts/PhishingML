{% extends 'base.html' %}

{% block title %}Model Eğitimi - PhishingML{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm mb-4 border-light">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-gear-fill me-2"></i>Model Eğitimi</h6>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="training-form">
                    <!-- Adım Göstergeleri -->
                    <div class="progress-container mb-4">
                        <div class="step-progress d-flex justify-content-between">
                            <div class="step-item active">
                                <div class="step-circle">1</div>
                                <div class="step-name mt-1 small">Veri Seti</div>
                            </div>
                            <div class="step-item">
                                <div class="step-circle">2</div>
                                <div class="step-name mt-1 small">Model Seçimi</div>
                            </div>
                            <div class="step-item">
                                <div class="step-circle">3</div>
                                <div class="step-name mt-1 small">Model Ayarları</div>
                            </div>
                            <div class="step-item">
                                <div class="step-circle">4</div>
                                <div class="step-name mt-1 small">Başlat</div>
                            </div>
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar" id="step-progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>

                    <!-- Adım 1: Veri Seti Seçimi -->
                    <div class="step-container" id="step-1">
                        
                        <div class="drop-zone rounded border-2 border-dashed border-primary p-4 text-center bg-light position-relative">
                            <input type="file" class="d-none" id="file" name="file" accept=".csv" required>
                            <div id="drop-content">
                                <i class="bi bi-cloud-arrow-up-fill text-primary fs-2 mb-2"></i>
                                <h5 class="fw-normal">CSV dosyasını sürükleyip bırakın</h5>
                                <p class="text-muted">veya</p>
                                <button type="button" class="btn btn-outline-primary" id="browse-button">Dosya Seçin</button>
                                <div id="file-info" class="mt-3 d-none">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="bi bi-file-earmark-spreadsheet text-success fs-3 me-2"></i>
                                        <span id="file-name" class="fw-medium"></span>
                                        <button type="button" class="btn btn-sm btn-link text-danger" id="remove-file">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="preview-data-btn">
                                        <i class="bi bi-eye me-1"></i>Veri Önizleme
                                    </button>
                                </div>
                            </div>
                            <div id="csv-validation-error" class="alert alert-danger mt-3 d-none">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <span>Lütfen geçerli bir CSV dosyası seçin</span>
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle me-1"></i> CSV dosyasının son sütunu hedef sınıf olmalıdır (1: Phishing, 0: Normal).
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="step-1-next">İlerle <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>

                    <!-- Veri Önizleme Modal -->
                    <div class="modal fade" id="dataPreviewModal" tabindex="-1" aria-labelledby="dataPreviewModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title" id="dataPreviewModalLabel">
                                        <i class="bi bi-table me-1"></i> Veri Önizleme
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="dataPreviewLoading" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Yükleniyor...</span>
                                        </div>
                                        <p class="mt-2">Veri yükleniyor...</p>
                                    </div>
                                    
                                    <div id="dataPreviewError" class="alert alert-danger d-none">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <span id="dataPreviewErrorMessage">Veri yüklenirken bir hata oluştu.</span>
                                    </div>
                                    
                                    <div id="dataPreviewContent" class="d-none">
                                        <div class="alert alert-info mb-3">
                                            <i class="bi bi-info-circle-fill me-2"></i>
                                            <span>İlk <span id="previewRowCount">10</span> satır gösteriliyor. Toplam satır sayısı: <span id="totalRowCount">0</span></span>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover" id="previewTable">
                                                <thead id="previewTableHead" class="table-light">
                                                    <!-- JavaScript ile doldurulacak -->
                                                </thead>
                                                <tbody id="previewTableBody">
                                                    <!-- JavaScript ile doldurulacak -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Adım 2: Model Seçimi -->
                    <div class="step-container" id="step-2" style="display: none;">
                        
                        <div class="row gy-3">
                            <div class="col-md-4">
                                <input type="radio" class="btn-check model-radio" name="model_type" value="random_forest" id="model_random_forest" autocomplete="off" checked>
                                <label class="model-card-label w-100 h-100" for="model_random_forest">
                                    <div class="card border-2 model-card h-100 shadow-sm">
                                        <div class="card-body p-3 text-center">
                                            <div class="model-selection-indicator position-absolute end-0 top-0 mt-2 me-2">
                                                <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                                            </div>
                                            <div class="model-icon rounded-circle bg-success-subtle d-flex align-items-center justify-content-center mx-auto mb-3">
                                                <i class="bi bi-diagram-3 fs-3 text-success"></i>
                                            </div>
                                            <h5 class="card-title mb-1">Random Forest</h5>
                                            <p class="card-text small text-muted">Çoklu karar ağaçları kullanan topluluk öğrenme modeli</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check model-radio" name="model_type" value="svm" id="model_svm" autocomplete="off">
                                <label class="model-card-label w-100 h-100" for="model_svm">
                                    <div class="card border-2 model-card h-100 shadow-sm">
                                        <div class="card-body p-3 text-center">
                                            <div class="model-selection-indicator position-absolute end-0 top-0 mt-2 me-2">
                                                <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                                            </div>
                                            <div class="model-icon rounded-circle bg-info-subtle d-flex align-items-center justify-content-center mx-auto mb-3">
                                                <i class="bi bi-grid-3x3-gap fs-3 text-info"></i>
                                            </div>
                                            <h5 class="card-title mb-1">SVM</h5>
                                            <p class="card-text small text-muted">Optimal ayrım düzlemiyle sınıflandırma yapan güçlü algoritma</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check model-radio" name="model_type" value="decision_tree" id="model_decision_tree" autocomplete="off">
                                <label class="model-card-label w-100 h-100" for="model_decision_tree">
                                    <div class="card border-2 model-card h-100 shadow-sm">
                                        <div class="card-body p-3 text-center">
                                            <div class="model-selection-indicator position-absolute end-0 top-0 mt-2 me-2">
                                                <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                                            </div>
                                            <div class="model-icon rounded-circle bg-warning-subtle d-flex align-items-center justify-content-center mx-auto mb-3">
                                                <i class="bi bi-diagram-2 fs-3 text-warning"></i>
                                            </div>
                                            <h5 class="card-title mb-1">Decision Tree</h5>
                                            <p class="card-text small text-muted">Ağaç yapısıyla kolay anlaşılır kural tabanlı model</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check model-radio" name="model_type" value="naive_bayes" id="model_naive_bayes" autocomplete="off">
                                <label class="model-card-label w-100 h-100" for="model_naive_bayes">
                                    <div class="card border-2 model-card h-100 shadow-sm">
                                        <div class="card-body p-3 text-center">
                                            <div class="model-selection-indicator position-absolute end-0 top-0 mt-2 me-2">
                                                <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                                            </div>
                                            <div class="model-icon rounded-circle bg-danger-subtle d-flex align-items-center justify-content-center mx-auto mb-3">
                                                <i class="bi bi-calculator fs-3 text-danger"></i>
                                            </div>
                                            <h5 class="card-title mb-1">Naive Bayes</h5>
                                            <p class="card-text small text-muted">Olasılık tabanlı hızlı sınıflandırma algoritması</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check model-radio" name="model_type" value="knn" id="model_knn" autocomplete="off">
                                <label class="model-card-label w-100 h-100" for="model_knn">
                                    <div class="card border-2 model-card h-100 shadow-sm">
                                        <div class="card-body p-3 text-center">
                                            <div class="model-selection-indicator position-absolute end-0 top-0 mt-2 me-2">
                                                <i class="bi bi-check-circle-fill fs-4 text-success"></i>
                                            </div>
                                            <div class="model-icon rounded-circle bg-primary-subtle d-flex align-items-center justify-content-center mx-auto mb-3">
                                                <i class="bi bi-people fs-3 text-primary"></i>
                                            </div>
                                            <h5 class="card-title mb-1">KNN</h5>
                                            <p class="card-text small text-muted">En yakın komşulara göre sınıflandırma yapan örnek tabanlı model</p>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="step-2-prev"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                            <button type="button" class="btn btn-primary" id="step-2-next">İlerle <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>

                    <!-- Adım 3: Model Hiperparametreleri -->
                    <div class="step-container" id="step-3" style="display: none;">
                        
                        <!-- Veri Bölme Ayarları - Tüm modeller için ortak -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body p-4">
                                <div class="alert alert-primary mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon rounded-circle bg-primary-subtle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-pie-chart-fill fs-5 text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Veri Bölme Ayarları</h6>
                                            <p class="mb-0 small">Veri setinizin eğitim ve test için nasıl bölüneceğini belirleyin</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <label for="train_test_split" class="form-label">Eğitim Veri Seti Oranı</label>
                                        <div class="d-flex align-items-center gap-3">
                                            <input type="range" class="form-range flex-grow-1" min="50" max="90" step="5" value="80" id="train_test_split_range">
                                            <div class="input-group" style="width: 120px;">
                                                <input type="number" class="form-control" id="train_test_split" name="train_test_split" value="80" min="50" max="90" step="5">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <div class="text-primary">
                                                    <strong>Eğitim: <span id="train_percent">80</span>%</strong>
                                                </div>
                                                <div class="text-secondary">
                                                    <strong>Test: <span id="test_percent">20</span>%</strong>
                                                </div>
                                            </div>
                                            <div class="progress mt-2" style="height: 15px;">
                                                <div class="progress-bar" id="train_progress" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                                                <div class="progress-bar bg-secondary" id="test_progress" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                        <div class="form-text mt-2">
                                            <i class="bi bi-info-circle me-1"></i> Veri setinizin ne kadarının model eğitimi için, ne kadarının test için kullanılacağını belirleyin. 
                                            Genellikle %70-%80 eğitim için ayrılır. Küçük veri setleri için daha yüksek eğitim oranı tercih edilebilir.
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Random Seed ayarı -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <label for="random_seed" class="form-label">Random Seed (Rasgelelik Tohumu)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="random_seed" name="random_seed" value="42" min="0" max="999999">
                                            <button class="btn btn-outline-secondary" type="button" id="generate_random_seed">
                                                <i class="bi bi-shuffle"></i> Rasgele
                                            </button>
                                        </div>
                                        <div class="form-text mt-1">
                                            <i class="bi bi-info-circle me-1"></i> Random Seed değeri, model eğitimindeki rastgeleliği kontrol eder. Aynı seed değeriyle yapılan eğitimler aynı sonuçları üretir.
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        
                        <div id="model-param-container" class="card border-0 shadow-sm">
                            <!-- Random Forest Parametreleri -->
                            <div id="random_forest_params" class="model-params card-body p-4">
                                <div class="alert alert-success mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon rounded-circle bg-success-subtle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-diagram-3 fs-5 text-success"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Random Forest Parametreleri</h6>
                                            <p class="mb-0 small">Topluluk öğrenme modeli için ince ayarlar</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="rf_n_estimators" class="form-label">Ağaç Sayısı</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="10" max="500" step="10" value="100" id="rf_n_estimators_range">
                                            <input type="number" class="form-control" id="rf_n_estimators" name="rf_n_estimators" value="100" min="10" max="500">
                                        </div>
                                        <div class="form-text">Toplulukta kaç ağaç olacağını belirler. Daha fazla ağaç doğruluğu artırabilir ancak eğitim süresini uzatır.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="rf_max_depth" class="form-label">Maksimum Ağaç Derinliği</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="1" max="32" value="10" id="rf_max_depth_range">
                                            <input type="number" class="form-control" id="rf_max_depth" name="rf_max_depth" value="10" min="1" max="32">
                                        </div>
                                        <div class="form-text">Her bir ağacın maksimum derinliği. Aşırı öğrenmeyi önlemek için sınırlandırılabilir.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="rf_min_samples_split" class="form-label">Bölme için Minimum Örnek</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="2" max="20" value="2" id="rf_min_samples_split_range">
                                            <input type="number" class="form-control" id="rf_min_samples_split" name="rf_min_samples_split" value="2" min="2" max="20">
                                        </div>
                                        <div class="form-text">Bir düğümü bölmek için gereken minimum örnek sayısı.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="rf_criterion" class="form-label">Kriter</label>
                                        <select class="form-select" id="rf_criterion" name="rf_criterion">
                                            <option value="gini" selected>Gini</option>
                                            <option value="entropy">Entropy</option>
                                        </select>
                                        <div class="form-text">Bölme kalitesini ölçme yöntemi.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SVM Parametreleri -->
                            <div id="svm_params" class="model-params card-body p-4" style="display: none;">
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon rounded-circle bg-info-subtle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-grid-3x3-gap fs-5 text-info"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">SVM Parametreleri</h6>
                                            <p class="mb-0 small">Destek Vektör Makinesi için ince ayarlar</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="svm_C" class="form-label">Düzenleme Parametresi (C)</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="0.1" max="10" step="0.1" value="1.0" id="svm_C_range">
                                            <input type="number" class="form-control" id="svm_C" name="svm_C" value="1.0" min="0.1" max="10" step="0.1">
                                        </div>
                                        <div class="form-text">Düşük C değeri daha yumuşak karar sınırı, yüksek C değeri daha sert karar sınırı sağlar.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="svm_kernel" class="form-label">Çekirdek (Kernel) Tipi</label>
                                        <select class="form-select" id="svm_kernel" name="svm_kernel">
                                            <option value="rbf" selected>RBF (Radial Basis Function)</option>
                                            <option value="linear">Linear</option>
                                            <option value="poly">Polynomial</option>
                                            <option value="sigmoid">Sigmoid</option>
                                        </select>
                                        <div class="form-text">Veri dönüşümü için kullanılacak çekirdek fonksiyonu.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="svm_gamma" class="form-label">Gamma</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="0.001" max="1" step="0.001" value="0.1" id="svm_gamma_range">
                                            <input type="number" class="form-control" id="svm_gamma" name="svm_gamma" value="0.1" min="0.001" max="1" step="0.001">
                                        </div>
                                        <div class="form-text">RBF, Polynomial ve Sigmoid çekirdekleri için çekirdek katsayısı.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Decision Tree Parametreleri -->
                            <div id="decision_tree_params" class="model-params card-body p-4" style="display: none;">
                                <div class="alert alert-warning mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon rounded-circle bg-warning-subtle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-diagram-2 fs-5 text-warning"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Decision Tree Parametreleri</h6>
                                            <p class="mb-0 small">Karar ağacı modeli için ince ayarlar</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="dt_max_depth" class="form-label">Maksimum Ağaç Derinliği</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="1" max="32" value="10" id="dt_max_depth_range">
                                            <input type="number" class="form-control" id="dt_max_depth" name="dt_max_depth" value="10" min="1" max="32">
                                        </div>
                                        <div class="form-text">Ağacın maksimum derinliği. Aşırı öğrenmeyi önlemek için sınırlandırılabilir.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="dt_min_samples_split" class="form-label">Bölme için Minimum Örnek</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="2" max="20" value="2" id="dt_min_samples_split_range">
                                            <input type="number" class="form-control" id="dt_min_samples_split" name="dt_min_samples_split" value="2" min="2" max="20">
                                        </div>
                                        <div class="form-text">Bir düğümü bölmek için gereken minimum örnek sayısı.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="dt_criterion" class="form-label">Kriter</label>
                                        <select class="form-select" id="dt_criterion" name="dt_criterion">
                                            <option value="gini" selected>Gini</option>
                                            <option value="entropy">Entropy</option>
                                        </select>
                                        <div class="form-text">Bölme kalitesini ölçme yöntemi.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Naive Bayes Parametreleri -->
                            <div id="naive_bayes_params" class="model-params card-body p-4" style="display: none;">
                                <div class="alert alert-danger mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon rounded-circle bg-danger-subtle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-calculator fs-5 text-danger"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Naive Bayes Parametreleri</h6>
                                            <p class="mb-0 small">Naive Bayes modeli için ince ayarlar</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="nb_var_smoothing" class="form-label">Varyans Düzeltme</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="0.000000001" max="0.1" step="0.000000001" value="0.000000001" id="nb_var_smoothing_range">
                                            <input type="number" class="form-control" id="nb_var_smoothing" name="nb_var_smoothing" value="1e-9" min="1e-9" max="0.1" step="1e-9">
                                        </div>
                                        <div class="form-text">Varyansa eklenen stabilite sabiti.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- KNN Parametreleri -->
                            <div id="knn_params" class="model-params card-body p-4" style="display: none;">
                                <div class="alert alert-primary mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="model-icon rounded-circle bg-primary-subtle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                            <i class="bi bi-people fs-5 text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">KNN Parametreleri</h6>
                                            <p class="mb-0 small">K-En Yakın Komşu modeli için ince ayarlar</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="knn_n_neighbors" class="form-label">Komşu Sayısı (K)</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" min="1" max="20" value="5" id="knn_n_neighbors_range">
                                            <input type="number" class="form-control" id="knn_n_neighbors" name="knn_n_neighbors" value="5" min="1" max="20">
                                        </div>
                                        <div class="form-text">Sınıflandırma için kullanılacak komşu sayısı.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="knn_weights" class="form-label">Ağırlıklandırma</label>
                                        <select class="form-select" id="knn_weights" name="knn_weights">
                                            <option value="uniform" selected>Uniform (Eşit)</option>
                                            <option value="distance">Distance (Mesafe Ağırlıklı)</option>
                                        </select>
                                        <div class="form-text">Komşuların oy ağırlığını belirler. Eşit veya mesafeye göre ağırlıklı.</div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label for="knn_metric" class="form-label">Mesafe Metriği</label>
                                        <select class="form-select" id="knn_metric" name="knn_metric">
                                            <option value="minkowski" selected>Minkowski</option>
                                            <option value="euclidean">Euclidean</option>
                                            <option value="manhattan">Manhattan</option>
                                        </select>
                                        <div class="form-text">Komşuları bulmak için kullanılacak mesafe hesaplama yöntemi.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="step-3-prev"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                            <button type="button" class="btn btn-primary" id="step-3-next">İlerle <i class="bi bi-arrow-right ms-1"></i></button>
                        </div>
                    </div>

                    <!-- Adım 4: Eğitimi Başlat (eski Adım 3) -->
                    <div class="step-container" id="step-4" style="display: none;">
                        
                        <div class="card border-0 bg-light shadow-sm p-4 mb-4">
                            <div class="card-body">
                                <h6 class="fw-medium mb-3">Eğitim Özeti</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="summary-item d-flex align-items-center p-2 border rounded bg-white">
                                            <i class="bi bi-file-earmark-text fs-4 text-primary me-3"></i>
                                            <div>
                                                <div class="small text-muted">Seçilen Veri Seti</div>
                                                <div class="fw-medium" id="selected-file-summary">-</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="summary-item d-flex align-items-center p-2 border rounded bg-white">
                                            <i class="bi bi-diagram-3 fs-4 text-primary me-3"></i>
                                            <div>
                                                <div class="small text-muted">Seçilen Model</div>
                                                <div class="fw-medium" id="selected-model-summary">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle-fill me-2"></i> Model eğitimi başladıktan sonra işlem tamamlanana kadar bekleyiniz. Eğitim süresi veri setinin büyüklüğüne ve modele göre değişebilir.
                        </div>
                        
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="step-4-prev"><i class="bi bi-arrow-left me-1"></i> Geri</button>
                            <button type="submit" class="btn btn-success"><i class="bi bi-play-fill me-1"></i>Eğitimi Başlat</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        {% if results %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-bar-chart-line-fill me-2"></i>Son Eğitim Sonuçları</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover" id="resultsTable" width="100%" cellspacing="0">
                        <thead class="table-primary">
                            <tr>
                                <th>Eğitim Adı</th>
                                <th>Veri Seti</th>
                                <th>Doğruluk</th>
                                <th>Kesinlik</th>
                                <th>Duyarlılık</th>
                                <th>F1 Skoru</th>
                                <th>Eğitim Süresi (sn)</th>
                                <th>Eğitim/Test Veri Sayısı</th>
                                <th>Model Dosyası</th>
                                <th>Eğitim Tarihi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td><i class="{{ result.icon_class }} me-1"></i>{{ result.model_name_display }} <small class="badge bg-secondary">{{ result.model_name }}</small></td>
                                <td>{{ result.dataset_name }}</td>
                                <td><span class="text-dark fs-6">{{ "%.1f"|format(result.accuracy) }}%</span></td>
                                <td><span class="text-dark fs-6">{{ "%.1f"|format(result.precision) }}%</span></td>
                                <td><span class="text-dark fs-6">{{ "%.1f"|format(result.recall) }}%</span></td>
                                <td><span class="text-dark fs-6">{{ "%.1f"|format(result.f1_score) }}%</span></td>
                                <td>{{ "%.2f"|format(result.training_time) }}</td>
                                <td>
                                    {% if result.train_samples_count %}
                                    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#trainDataModal{{ loop.index }}_result">
                                        <i class="bi bi-database-fill"></i> {{ result.train_samples_count }}
                                    </button>
                                    /
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#testDataModal{{ loop.index }}_result">
                                        <i class="bi bi-database"></i> {{ result.test_samples_count }}
                                    </button>
                                    {% else %}
                                    <span class="text-muted">Veri sayısı bulunamadı</span>
                                    {% endif %}
                                </td>
                                <td id="model-file-name" class="text-dark text-break" style="word-wrap: break-word; max-width: 200px;"></td>
                                <td>{{ result.formatted_date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card shadow-sm mb-4 border-light">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-hdd-stack-fill me-2"></i>Kayıt Edilmiş Model Eğitimleri</h6>
                {% if trained_models and trained_models|length > 0 %}
                <form method="POST" action="{{ url_for('delete_all_history_route') }}" onsubmit="return confirm('Tüm eğitim geçmişi silinecek. Emin misiniz?');" class="ms-auto">
                    <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3-fill me-1"></i>Tüm Geçmişi Sil</button>
                </form>
                {% endif %}
            </div>
            <div class="card-body">
                {% if trained_models and trained_models|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-borderless table-hover shadow-sm" id="historyTable">
                        <thead>
                            <tr class="bg-light">
                                <th class="fw-semibold rounded-start text-primary py-3 small text-uppercase">Eğitim Adı</th>
                                <th class="fw-semibold text-primary py-3 small text-uppercase">Veri Seti</th>
                                <th class="fw-semibold text-primary py-3 text-center small text-uppercase">Doğruluk</th>
                                <th class="fw-semibold text-primary py-3 text-center small text-uppercase">Kesinlik</th>
                                <th class="fw-semibold text-primary py-3 text-center small text-uppercase">Duyarlılık</th>
                                <th class="fw-semibold text-primary py-3 text-center small text-uppercase">F1 Skoru</th>
                                <th class="fw-semibold text-primary py-3 text-center small text-uppercase">Veri Sayısı</th>
                                <th class="fw-semibold rounded-end text-primary py-3 text-center small text-uppercase">İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in trained_models %}
                            <tr class="align-middle border-bottom">
                                <td class="py-3">
                                    <div class="d-flex align-items-center">
                                        <i class="{{ model.icon_class }} fs-5 me-2"></i>
                                        <div>
                                            <div class="fw-medium lh-sm text-truncate-cell" data-full-text="{{ model.model_name_display }}">{{ model.model_name_display }}</div>
                                            <div><small class="badge bg-light text-primary fs-10">{{ model.model_name }}</small></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3 fs-6">
                                    <span class="text-truncate-cell" data-full-text="{{ model.dataset_name }}">{{ model.dataset_name }}</span>
                                </td>
                                <td class="py-3 text-center"><span class="text-dark fs-6">{{ "%.1f"|format(model.accuracy) }}%</span></td>
                                <td class="py-3 text-center"><span class="text-dark fs-6">{{ "%.1f"|format(model.precision) }}%</span></td>
                                <td class="py-3 text-center"><span class="text-dark fs-6">{{ "%.1f"|format(model.recall) }}%</span></td>
                                <td class="py-3 text-center"><span class="text-dark fs-6">{{ "%.1f"|format(model.f1_score) }}%</span></td>
                                <td class="py-3 text-center">
                                    {% if model.train_samples_count %}
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-dark border-0" data-bs-toggle="modal" data-bs-target="#trainDataModal{{ loop.index }}_history" title="Eğitim Verileri">
                                            <i class="bi bi-database-fill text-dark"></i> <span class="fs-6">{{ model.train_samples_count }}</span>
                                        </button>
                                        <span class="text-dark mx-1 fs-6">/</span>
                                        <button type="button" class="btn btn-sm btn-outline-dark border-0" data-bs-toggle="modal" data-bs-target="#testDataModal{{ loop.index }}_history" title="Test Verileri">
                                            <i class="bi bi-database text-dark"></i> <span class="fs-6">{{ model.test_samples_count }}</span>
                                        </button>
                                    </div>
                                    {% else %}
                                    <span class="text-dark fst-italic fs-6">Veri sayısı bulunamadı</span>
                                    {% endif %}
                                </td>
                                <td class="py-3 text-center">
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="openModelDetailsModal({{ model.id }})" data-bs-toggle="tooltip" data-bs-placement="top" title="Detaylar">
                                            <i class="bi bi-info-circle-fill"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="openEditModal({{ model.id }}, '{{ model.model_name_display }}')" data-bs-toggle="tooltip" data-bs-placement="top" title="Düzenle">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-dark" onclick="openLogsModal({{ model.id }})" data-bs-toggle="tooltip" data-bs-placement="top" title="Loglar">
                                            <i class="bi bi-terminal-fill"></i>
                                        </button>
                                        <form method="POST" action="{{ url_for('delete_history_entry_route', entry_id=model.id) }}" onsubmit="return confirm('Bu kayıt silinecek. Emin misiniz?');" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Sil">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center py-4 text-dark fst-italic fs-6">Geçmiş eğitim kaydı bulunmamaktadır.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-database-x fs-2 text-muted mb-3"></i>
                    <p class="text-muted">Kayıtlı eğitim bulunamadı. Model eğittikten sonra kaydedebilirsiniz.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.model-icon {
    width: 60px;
    height: 60px;
}

.model-card {
    transition: all 0.3s ease;
    border-color: transparent;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.btn-check:checked + .model-card-label .model-card {
    border-color: var(--bs-success);
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(25, 135, 84, 0.2) !important;
    background-color: rgba(25, 135, 84, 0.05);
}

.model-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
}

/* Seçim göstergesi (onay işareti) varsayılan olarak gizli */
.model-selection-indicator {
    display: none;
    z-index: 5;
}

/* Seçili model için onay işareti göster */
.btn-check:checked + .model-card-label .model-selection-indicator {
    display: block;
}

/* Seçili modelin başlığını vurgula */
.btn-check:checked + .model-card-label .card-title {
    color: var(--bs-success);
    font-weight: 600;
}

/* Seçili model kartına üstte şerit ekle */
.btn-check:checked + .model-card-label .model-card::before {
    content: "SEÇİLDİ";
    position: absolute;
    top: 10px;
    left: -30px;
    background-color: var(--bs-success);
    color: white;
    padding: 2px 30px;
    font-size: 10px;
    font-weight: bold;
    transform: rotate(-45deg);
    transform-origin: center;
    z-index: 10;
}

.section-icon {
    width: 36px;
    height: 36px;
    background-color: var(--bs-primary);
}

.section-title {
    color: var(--bs-gray-700);
}

/* İlerleme çubuğu stilleri */
.step-progress {
    position: relative;
    width: 100%;
    z-index: 1;
}

.step-progress::before {
    content: '';
    position: absolute;
    top: 17px;
    left: 50px;
    right: 50px;
    height: 2px;
    background: #dee2e6;
    z-index: -1;
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 1;
    flex: 1;
}

.step-circle {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background-color: #e9ecef;
    border: 2px solid #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.step-name {
    color: #6c757d;
    text-align: center;
}

.step-item.active .step-circle {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

.step-item.active .step-name {
    color: var(--bs-primary);
    font-weight: bold;
}

.step-item.completed .step-circle {
    background-color: var(--bs-success);
    border-color: var(--bs-success);
    color: white;
}

/* Veri seti özeti stili */
.summary-item {
    transition: all 0.2s ease;
}

.summary-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // İlerleme adımları için gerekli değişkenler
        const form = document.getElementById('training-form');
        const fileInput = document.getElementById('file');
        const fileName = document.getElementById('file-name');
        const fileInfo = document.getElementById('file-info');
        const dropZone = document.querySelector('.drop-zone');
        const browseButton = document.getElementById('browse-button');
        const removeFileButton = document.getElementById('remove-file');
        const progressBar = document.getElementById('step-progress-bar');
        const stepItems = document.querySelectorAll('.step-item');
        const csvValidationError = document.getElementById('csv-validation-error');
        const previewDataBtn = document.getElementById('preview-data-btn');
        
        // Veri önizleme modal elementleri
        const dataPreviewModal = new bootstrap.Modal(document.getElementById('dataPreviewModal'));
        const dataPreviewLoading = document.getElementById('dataPreviewLoading');
        const dataPreviewError = document.getElementById('dataPreviewError');
        const dataPreviewErrorMessage = document.getElementById('dataPreviewErrorMessage');
        const dataPreviewContent = document.getElementById('dataPreviewContent');
        const totalRowCount = document.getElementById('totalRowCount');
        const previewTableHead = document.getElementById('previewTableHead');
        const previewTableBody = document.getElementById('previewTableBody');
        
        // Adım container'ları
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');
        const step4 = document.getElementById('step-4');
        
        // Butonlar
        const step1Next = document.getElementById('step-1-next');
        const step2Prev = document.getElementById('step-2-prev');
        const step2Next = document.getElementById('step-2-next');
        const step3Prev = document.getElementById('step-3-prev');
        const step3Next = document.getElementById('step-3-next');
        const step4Prev = document.getElementById('step-4-prev');
        
        // Özet alanları
        const selectedFileSummary = document.getElementById('selected-file-summary');
        const selectedModelSummary = document.getElementById('selected-model-summary');
        
        // Geçerli CSV dosyası kontrolü
        let isValidCSV = false;
        
        // Model seçimi ve parametre panellerini kontrol etme
        const modelRadios = document.querySelectorAll('input[name="model_type"]');
        const modelParams = document.querySelectorAll('.model-params');
        
        // Range input'ları ile number input'ları senkronize etme
        const rangeInputs = document.querySelectorAll('input[type="range"]');
        
        // Her bir range input için value değişimini izle
        rangeInputs.forEach(range => {
            const targetInput = document.getElementById(range.id.replace('_range', ''));
            
            // Range değeri değiştiğinde number input'u güncelle
            range.addEventListener('input', function() {
                targetInput.value = this.value;
            });
            
            // Number input değeri değiştiğinde range'i güncelle
            targetInput.addEventListener('input', function() {
                range.value = this.value;
            });
        });
        
        // Model radio butonları değiştiğinde
        modelRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Seçilen modelin parametre panelini göster, diğerlerini gizle
                const selectedParamPanel = document.getElementById(this.value + '_params');
                
                modelParams.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                if (selectedParamPanel) {
                    selectedParamPanel.style.display = 'block';
                }
            });
        });
        
        // CSV dosyası doğrulama fonksiyonu
        function validateCSVFile(file) {
            // Dosya uzantısı kontrolü
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'csv') {
                return false;
            }
            
            // Dosya içeriği kontrolü (ilk birkaç karakter kontrolü)
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    
                    // Dosya içeriğinin ilk karakterlerini kontrol et
                    // CSV dosyaları genellikle virgülle ayrılmış veriler içerir
                    // En azından bir virgül beklenir ve satır sonları olmalı
                    const hasCommas = content.indexOf(',') > -1;
                    const hasNewlines = content.indexOf('\n') > -1 || content.indexOf('\r') > -1;
                    
                    // İçerik metin olmalı ve CSV formatı belirtileri taşımalı
                    resolve(typeof content === 'string' && hasCommas && hasNewlines);
                };
                
                // İlk 1024 byte'ı oku (başlık satırı ve birkaç veri satırı yeterli)
                reader.readAsText(file.slice(0, 1024));
            });
        }
        
        // Dosya bilgilerini güncelleme
        async function updateFileInfo() {
            csvValidationError.classList.add('d-none');
            isValidCSV = false;
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileName.textContent = file.name;
                fileInfo.classList.remove('d-none');
                
                // "Kayıt Edilmiş Model Eğitimleri" kartını gizle
                const trainedModelsCards = document.querySelectorAll('.card.shadow-sm.mb-4.border-light');
                trainedModelsCards.forEach(card => {
                    // İçinde "Kayıt Edilmiş Model Eğitimleri" yazısı olan kartı bul
                    if (card.textContent.includes('Kayıt Edilmiş Model Eğitimleri')) {
                        card.classList.add('d-none');
                    }
                });
                
                // CSV doğrulaması yap
                try {
                    isValidCSV = await validateCSVFile(file);
                    
                    if (isValidCSV) {
                        dropZone.classList.add('border-success');
                        dropZone.classList.remove('border-primary', 'border-danger');
                        csvValidationError.classList.add('d-none');
                    } else {
                        dropZone.classList.add('border-danger');
                        dropZone.classList.remove('border-primary', 'border-success');
                        csvValidationError.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Dosya doğrulama hatası:', error);
                    isValidCSV = false;
                    dropZone.classList.add('border-danger');
                    dropZone.classList.remove('border-primary', 'border-success');
                    csvValidationError.classList.remove('d-none');
                }
            } else {
                fileInfo.classList.add('d-none');
                dropZone.classList.remove('border-success', 'border-danger');
                dropZone.classList.add('border-primary');
                
                // "Kayıt Edilmiş Model Eğitimleri" kartını tekrar göster
                const trainedModelsCards = document.querySelectorAll('.card.shadow-sm.mb-4.border-light');
                trainedModelsCards.forEach(card => {
                    // İçinde "Kayıt Edilmiş Model Eğitimleri" yazısı olan kartı bul
                    if (card.textContent.includes('Kayıt Edilmiş Model Eğitimleri')) {
                        card.classList.remove('d-none');
                    }
                });
            }
        }
        
        // İlk adımdan ikinci adıma geçiş
        step1Next.addEventListener('click', function() {
            if (!fileInput.files.length) {
                alert('Lütfen bir veri seti dosyası seçin.');
                return;
            }
            
            if (!isValidCSV) {
                alert('Lütfen geçerli bir CSV dosyası seçin. Dosya içeriği CSV formatında olmalıdır.');
                csvValidationError.classList.remove('d-none');
                return;
            }
            
            step1.style.display = 'none';
            step2.style.display = 'block';
            progressBar.style.width = '25%';
            progressBar.setAttribute('aria-valuenow', '25');
            
            // İlerleme durumunu güncelle
            stepItems[0].classList.add('completed');
            stepItems[1].classList.add('active');
        });
        
        // İkinci adımdan birinci adıma geri dönüş
        step2Prev.addEventListener('click', function() {
            step2.style.display = 'none';
            step1.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.setAttribute('aria-valuenow', '0');
            
            // İlerleme durumunu güncelle
            stepItems[1].classList.remove('active');
            stepItems[0].classList.remove('completed');
            stepItems[0].classList.add('active');
        });
        
        // İkinci adımdan üçüncü adıma geçiş
        step2Next.addEventListener('click', function() {
            const selectedModel = document.querySelector('input[name="model_type"]:checked');
            if (!selectedModel) {
                alert('Lütfen bir model seçin.');
                return;
            }
            
            step2.style.display = 'none';
            step3.style.display = 'block';
            progressBar.style.width = '50%';
            progressBar.setAttribute('aria-valuenow', '50');
            
            // İlerleme durumunu güncelle
            stepItems[1].classList.remove('active');
            stepItems[1].classList.add('completed');
            stepItems[2].classList.add('active');
            
            // Seçilen modelin parametre panelini göster
            const selectedParamPanel = document.getElementById(selectedModel.value + '_params');
            
            modelParams.forEach(panel => {
                panel.style.display = 'none';
            });
            
            if (selectedParamPanel) {
                selectedParamPanel.style.display = 'block';
            }
        });
        
        // Üçüncü adımdan ikinci adıma geri dönüş
        step3Prev.addEventListener('click', function() {
            step3.style.display = 'none';
            step2.style.display = 'block';
            progressBar.style.width = '25%';
            progressBar.setAttribute('aria-valuenow', '25');
            
            // İlerleme durumunu güncelle
            stepItems[2].classList.remove('active');
            stepItems[1].classList.remove('completed');
            stepItems[1].classList.add('active');
        });
        
        // Üçüncü adımdan dördüncü adıma geçiş
        step3Next.addEventListener('click', function() {
            step3.style.display = 'none';
            step4.style.display = 'block';
            progressBar.style.width = '75%';
            progressBar.setAttribute('aria-valuenow', '75');
            
            // İlerleme durumunu güncelle
            stepItems[2].classList.remove('active');
            stepItems[2].classList.add('completed');
            stepItems[3].classList.add('active');
            
            // Özet bilgilerini doldur
            updateSummary();
        });
        
        // Dördüncü adımdan üçüncü adıma geri dönüş
        step4Prev.addEventListener('click', function() {
            step4.style.display = 'none';
            step3.style.display = 'block';
            progressBar.style.width = '50%';
            progressBar.setAttribute('aria-valuenow', '50');
            
            // İlerleme durumunu güncelle
            stepItems[3].classList.remove('active');
            stepItems[2].classList.remove('completed');
            stepItems[2].classList.add('active');
        });
        
        // Form gönderim kontrolü
        form.addEventListener('submit', function(e) {
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Lütfen bir veri seti dosyası seçin.');
                return;
            }
            
            if (!isValidCSV) {
                e.preventDefault();
                alert('Lütfen geçerli bir CSV dosyası seçin. Dosya içeriği CSV formatında olmalıdır.');
                return;
            }
            
            const selectedModel = document.querySelector('input[name="model_type"]:checked');
            if (!selectedModel) {
                e.preventDefault();
                alert('Lütfen bir model seçin.');
                return;
            }
            
            // İlerleme durumunu tamamla
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', '100');
            
            // İlerleme göstergelerini güncelle
            stepItems[3].classList.remove('active');
            stepItems[3].classList.add('completed');
        });
        
        // Dosya bilgilerini güncelleme
        function updateSummary() {
            if (fileInput.files.length > 0) {
                selectedFileSummary.textContent = fileInput.files[0].name;
            } else {
                selectedFileSummary.textContent = "Dosya seçilmedi";
            }
            
            const selectedModel = document.querySelector('input[name="model_type"]:checked');
            if (selectedModel) {
                const modelLabel = document.querySelector(`label[for="${selectedModel.id}"] .card-title`).textContent;
                selectedModelSummary.textContent = modelLabel;
            } else {
                selectedModelSummary.textContent = "Model seçilmedi";
            }
        }
        
        // İlk model radio butonunu varsayılan olarak seç
        if (modelRadios.length > 0 && modelRadios[0].checked) {
            const defaultParamPanel = document.getElementById(modelRadios[0].value + '_params');
            if (defaultParamPanel) {
                defaultParamPanel.style.display = 'block';
            }
        }
        
        // Dosya seçme butonu kontrolü
        browseButton.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Dosya seçildiğinde
        fileInput.addEventListener('change', function() {
            updateFileInfo();
        });
        
        // Dosyayı kaldır
        removeFileButton.addEventListener('click', function() {
            fileInput.value = '';
            updateFileInfo();
        });
        
        // Sürükle bırak olayları
        ['dragover', 'dragenter'].forEach(eventName => {
            dropZone.addEventListener(eventName, function(e) {
                e.preventDefault();
                dropZone.classList.add('bg-primary-subtle');
            }, false);
        });
        
        ['dragleave', 'dragend'].forEach(eventName => {
            dropZone.addEventListener(eventName, function(e) {
                e.preventDefault();
                dropZone.classList.remove('bg-primary-subtle');
            }, false);
        });
        
        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('bg-primary-subtle');
            
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                updateFileInfo();
            }
        }, false);

        // Veri önizleme butonu kontrolü
        if (previewDataBtn) {
            previewDataBtn.addEventListener('click', function() {
                if (!fileInput.files.length) {
                    alert('Önce bir CSV dosyası seçin.');
                    return;
                }
                
                if (!isValidCSV) {
                    alert('Geçerli bir CSV dosyası değil. Lütfen doğru formatta bir dosya seçin.');
                    return;
                }
                
                // Modal'ı göster ve CSV verisini yükle
                showDataPreview(fileInput.files[0]);
            });
        }
        
        // CSV verisi önizleme fonksiyonu
        function showDataPreview(file) {
            // Modal içeriğini sıfırla
            previewTableHead.innerHTML = '';
            previewTableBody.innerHTML = '';
            dataPreviewLoading.classList.remove('d-none');
            dataPreviewError.classList.add('d-none');
            dataPreviewContent.classList.add('d-none');
            
            // Modal'ı göster
            dataPreviewModal.show();
            
            // CSV dosyasını oku
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const csvData = event.target.result;
                    const parsedData = parseCSV(csvData);
                    
                    if (parsedData && parsedData.length > 0) {
                        // Toplam satır sayısını göster
                        totalRowCount.textContent = parsedData.length;
                        
                        // Başlık satırını oluştur
                        const headers = Object.keys(parsedData[0]);
                        const headerRow = document.createElement('tr');
                        
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });
                        
                        previewTableHead.appendChild(headerRow);
                        
                        // Veri satırlarını oluştur (en fazla 10 satır)
                        const rowsToShow = Math.min(10, parsedData.length);
                        
                        for (let i = 0; i < rowsToShow; i++) {
                            const row = document.createElement('tr');
                            
                            headers.forEach(header => {
                                const td = document.createElement('td');
                                td.textContent = parsedData[i][header];
                                row.appendChild(td);
                            });
                            
                            previewTableBody.appendChild(row);
                        }
                        
                        // Yükleme göstergesini gizle, içeriği göster
                        dataPreviewLoading.classList.add('d-none');
                        dataPreviewContent.classList.remove('d-none');
                    } else {
                        throw new Error('CSV verisi boş veya hatalı format.');
                    }
                } catch (error) {
                    console.error('CSV parse hatası:', error);
                    dataPreviewLoading.classList.add('d-none');
                    dataPreviewError.classList.remove('d-none');
                    dataPreviewErrorMessage.textContent = 'CSV verisi işlenirken hata oluştu: ' + error.message;
                }
            };
            
            reader.onerror = function() {
                dataPreviewLoading.classList.add('d-none');
                dataPreviewError.classList.remove('d-none');
                dataPreviewErrorMessage.textContent = 'Dosya okuma hatası.';
            };
            
            reader.readAsText(file);
        }
        
        // CSV parser fonksiyonu
        function parseCSV(csvText) {
            // Satır sonlarını standartlaştır
            csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Satırlara böl
            const lines = csvText.split('\n');
            
            // Boş satırları temizle
            const nonEmptyLines = lines.filter(line => line.trim() !== '');
            
            if (nonEmptyLines.length === 0) {
                return [];
            }
            
            // Başlık satırını ayır
            const headers = nonEmptyLines[0].split(',').map(header => header.trim());
            
            // Veri satırlarını işle
            const result = [];
            
            for (let i = 1; i < nonEmptyLines.length; i++) {
                const obj = {};
                const currentLine = nonEmptyLines[i].split(',');
                
                // Eğer başlık sayısı ve mevcut satırdaki değer sayısı uyuşmuyorsa, atla
                if (currentLine.length !== headers.length) {
                    console.warn(`Satır ${i + 1} başlık sayısıyla eşleşmiyor, atlanıyor.`);
                    continue;
                }
                
                // Her bir değeri ilgili başlıkla eşleştir
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentLine[j].trim();
                }
                
                result.push(obj);
            }
            
            return result;
        }

        // Eğitim-Test bölme oranı kontrolü
        const trainTestSplitRange = document.getElementById('train_test_split_range');
        const trainTestSplitInput = document.getElementById('train_test_split');
        const trainPercent = document.getElementById('train_percent');
        const testPercent = document.getElementById('test_percent');
        const trainProgress = document.getElementById('train_progress');
        const testProgress = document.getElementById('test_progress');
        
        // Eğitim-Test oranını güncelleme fonksiyonu
        function updateTrainTestSplit(value) {
            const trainValue = parseInt(value);
            const testValue = 100 - trainValue;
            
            // Metin göstergelerini güncelle
            trainPercent.textContent = trainValue;
            testPercent.textContent = testValue;
            
            // İlerleme çubuklarını güncelle
            trainProgress.style.width = trainValue + '%';
            trainProgress.setAttribute('aria-valuenow', trainValue);
            testProgress.style.width = testValue + '%';
            testProgress.setAttribute('aria-valuenow', testValue);
            
            // Input değerlerini güncelle
            trainTestSplitRange.value = trainValue;
            trainTestSplitInput.value = trainValue;
        }
        
        // Range değişikliğini izle
        trainTestSplitRange.addEventListener('input', function() {
            updateTrainTestSplit(this.value);
        });
        
        // Number input değişikliğini izle
        trainTestSplitInput.addEventListener('input', function() {
            // Minimum ve maksimum değer kontrolü
            let value = parseInt(this.value);
            if (isNaN(value)) value = 80;
            if (value < 50) value = 50;
            if (value > 90) value = 90;
            
            updateTrainTestSplit(value);
        });
        
        // Random Seed işlemleri
        const randomSeedInput = document.getElementById('random_seed');
        const generateRandomSeedBtn = document.getElementById('generate_random_seed');
        
        // Rastgele seed oluşturma butonu
        generateRandomSeedBtn.addEventListener('click', function() {
            const randomSeed = Math.floor(Math.random() * 1000000);
            randomSeedInput.value = randomSeed;
        });
    });
</script>

<!-- Eğitim ve Test Veri Modalları -->
{% if results %}
    {% for result in results %}
    <!-- Eğitim Verileri Modalı -->
    <div class="modal fade" id="trainDataModal{{ loop.index }}_result" tabindex="-1" aria-labelledby="trainDataModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="trainDataModalLabel{{ loop.index }}">
                        <i class="bi bi-database-fill me-1"></i> Eğitim Verileri ({{ result.train_samples_count }} örnek)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">En fazla 10 örnek gösterilmektedir.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="trainDataTable{{ loop.index }}">
                            <thead class="table-info">
                                <tr id="trainDataHeader{{ loop.index }}">
                                    <!-- JS ile doldurulacak -->
                                </tr>
                            </thead>
                            <tbody id="trainDataBody{{ loop.index }}">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Verileri Modalı -->
    <div class="modal fade" id="testDataModal{{ loop.index }}_result" tabindex="-1" aria-labelledby="testDataModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="testDataModalLabel{{ loop.index }}">
                        <i class="bi bi-database me-1"></i> Test Verileri ({{ result.test_samples_count }} örnek)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">En fazla 10 örnek gösterilmektedir.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="testDataTable{{ loop.index }}">
                            <thead class="table-secondary">
                                <tr id="testDataHeader{{ loop.index }}">
                                    <!-- JS ile doldurulacak -->
                                </tr>
                            </thead>
                            <tbody id="testDataBody{{ loop.index }}">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bu script, modal içindeki tabloları JSON verisiyle dolduracak -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Eğitim verileri
        try {
            const trainData{{ loop.index }} = JSON.parse('{{ result.train_data_json|safe }}');
            if (trainData{{ loop.index }} && trainData{{ loop.index }}.length > 0) {
                // Başlık satırını oluştur
                const trainHeader{{ loop.index }} = document.getElementById('trainDataHeader{{ loop.index }}');
                const trainKeys = Object.keys(trainData{{ loop.index }}[0]);
                
                trainKeys.forEach(function(key) {
                    const th = document.createElement('th');
                    th.textContent = key;
                    trainHeader{{ loop.index }}.appendChild(th);
                });
                
                // Veri satırlarını oluştur
                const trainBody{{ loop.index }} = document.getElementById('trainDataBody{{ loop.index }}');
                trainData{{ loop.index }}.forEach(function(item) {
                    const row = document.createElement('tr');
                    trainKeys.forEach(function(key) {
                        const td = document.createElement('td');
                        td.textContent = item[key];
                        row.appendChild(td);
                    });
                    trainBody{{ loop.index }}.appendChild(row);
                });
            } else {
                document.getElementById('trainDataBody{{ loop.index }}').innerHTML = '<tr><td colspan="100%" class="text-center">Veri bulunamadı</td></tr>';
            }
        } catch (error) {
            console.error('Eğitim verisi işlenirken hata oluştu:', error);
            document.getElementById('trainDataBody{{ loop.index }}').innerHTML = '<tr><td colspan="100%" class="text-center">Veri yüklenirken hata oluştu</td></tr>';
        }
        
        // Test verileri
        try {
            const testData{{ loop.index }} = JSON.parse('{{ result.test_data_json|safe }}');
            if (testData{{ loop.index }} && testData{{ loop.index }}.length > 0) {
                // Başlık satırını oluştur
                const testHeader{{ loop.index }} = document.getElementById('testDataHeader{{ loop.index }}');
                const testKeys = Object.keys(testData{{ loop.index }}[0]);
                
                testKeys.forEach(function(key) {
                    const th = document.createElement('th');
                    th.textContent = key;
                    testHeader{{ loop.index }}.appendChild(th);
                });
                
                // Veri satırlarını oluştur
                const testBody{{ loop.index }} = document.getElementById('testDataBody{{ loop.index }}');
                testData{{ loop.index }}.forEach(function(item) {
                    const row = document.createElement('tr');
                    testKeys.forEach(function(key) {
                        const td = document.createElement('td');
                        td.textContent = item[key];
                        row.appendChild(td);
                    });
                    testBody{{ loop.index }}.appendChild(row);
                });
            } else {
                document.getElementById('testDataBody{{ loop.index }}').innerHTML = '<tr><td colspan="100%" class="text-center">Veri bulunamadı</td></tr>';
            }
        } catch (error) {
            console.error('Test verisi işlenirken hata oluştu:', error);
            document.getElementById('testDataBody{{ loop.index }}').innerHTML = '<tr><td colspan="100%" class="text-center">Veri yüklenirken hata oluştu</td></tr>';
        }
    });
    </script>
    {% endfor %}
{% endif %}

<!-- Geçmiş model verileri için modallar -->
{% if trained_models %}
    {% for model in trained_models %}
    <!-- Eğitim Verileri Modalı -->
    <div class="modal fade" id="trainDataModal{{ loop.index }}_history" tabindex="-1" aria-labelledby="trainDataModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="trainDataModalLabel{{ loop.index }}">
                        <i class="bi bi-database-fill me-1"></i> Eğitim Verileri ({{ model.train_samples_count }} örnek)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">En fazla 10 örnek gösterilmektedir.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="historyTrainDataTable{{ loop.index }}">
                            <thead class="table-info">
                                <tr id="historyTrainDataHeader{{ loop.index }}">
                                    <!-- JS ile doldurulacak -->
                                </tr>
                            </thead>
                            <tbody id="historyTrainDataBody{{ loop.index }}">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Verileri Modalı -->
    <div class="modal fade" id="testDataModal{{ loop.index }}_history" tabindex="-1" aria-labelledby="testDataModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="testDataModalLabel{{ loop.index }}">
                        <i class="bi bi-database me-1"></i> Test Verileri ({{ model.test_samples_count }} örnek)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">En fazla 10 örnek gösterilmektedir.</p>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="historyTestDataTable{{ loop.index }}">
                            <thead class="table-secondary">
                                <tr id="historyTestDataHeader{{ loop.index }}">
                                    <!-- JS ile doldurulacak -->
                                </tr>
                            </thead>
                            <tbody id="historyTestDataBody{{ loop.index }}">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bu script, modal içindeki tabloları JSON verisiyle dolduracak -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Eğitim verileri
        try {
            console.log("Geçmiş model #{{ loop.index }} için eğitim verisi JSON işleme başlıyor...");
            const trainDataJson = '{{ model.training_data_json|safe }}';
            console.log("Ham JSON ilk 100 karakter:", (trainDataJson || "").substring(0, 100) + "...");
            
            let trainData = [];
            try {
                if (trainDataJson && trainDataJson.trim() !== '') {
                    trainData = JSON.parse(trainDataJson);
                    console.log("Eğitim verisi JSON başarıyla ayrıştırıldı");
                } else {
                    console.log("Eğitim verisi JSON boş");
                }
            } catch (jsonError) {
                console.error("Eğitim verisi JSON ayrıştırma hatası:", jsonError);
            }
            
            if (trainData && trainData.length > 0) {
                // Başlık satırını oluştur
                const trainHeader = document.getElementById('historyTrainDataHeader{{ loop.index }}');
                if (!trainHeader) {
                    console.error("historyTrainDataHeader{{ loop.index }} elementi bulunamadı");
                    return;
                }
                
                const trainKeys = Object.keys(trainData[0]);
                console.log("Eğitim verisi sütun başlıkları:", trainKeys);
                
                trainKeys.forEach(function(key) {
                    const th = document.createElement('th');
                    th.textContent = key;
                    trainHeader.appendChild(th);
                });
                
                // Veri satırlarını oluştur
                const trainBody = document.getElementById('historyTrainDataBody{{ loop.index }}');
                if (!trainBody) {
                    console.error("historyTrainDataBody{{ loop.index }} elementi bulunamadı");
                    return;
                }
                
                trainData.forEach(function(item) {
                    const row = document.createElement('tr');
                    trainKeys.forEach(function(key) {
                        const td = document.createElement('td');
                        td.textContent = item[key];
                        row.appendChild(td);
                    });
                    trainBody.appendChild(row);
                });
                console.log("Eğitim verisi tablosu oluşturuldu");
            } else {
                const trainBody = document.getElementById('historyTrainDataBody{{ loop.index }}');
                if (trainBody) {
                    trainBody.innerHTML = '<tr><td colspan="100%" class="text-center">Veri bulunamadı veya boş</td></tr>';
                }
            }
        } catch (error) {
            console.error('Eğitim verisi işlenirken genel hata:', error);
            const trainBody = document.getElementById('historyTrainDataBody{{ loop.index }}');
            if (trainBody) {
                trainBody.innerHTML = '<tr><td colspan="100%" class="text-center">Veri yüklenirken hata oluştu: ' + error.message + '</td></tr>';
            }
        }
        
        // Test verileri
        try {
            console.log("Geçmiş model #{{ loop.index }} için test verisi JSON işleme başlıyor...");
            const testDataJson = '{{ model.test_data_json|safe }}';
            console.log("Ham JSON ilk 100 karakter:", (testDataJson || "").substring(0, 100) + "...");
            
            let testData = [];
            try {
                if (testDataJson && testDataJson.trim() !== '') {
                    testData = JSON.parse(testDataJson);
                    console.log("Test verisi JSON başarıyla ayrıştırıldı");
                } else {
                    console.log("Test verisi JSON boş");
                }
            } catch (jsonError) {
                console.error("Test verisi JSON ayrıştırma hatası:", jsonError);
            }
            
            if (testData && testData.length > 0) {
                // Başlık satırını oluştur
                const testHeader = document.getElementById('historyTestDataHeader{{ loop.index }}');
                if (!testHeader) {
                    console.error("historyTestDataHeader{{ loop.index }} elementi bulunamadı");
                    return;
                }
                
                const testKeys = Object.keys(testData[0]);
                console.log("Test verisi sütun başlıkları:", testKeys);
                
                testKeys.forEach(function(key) {
                    const th = document.createElement('th');
                    th.textContent = key;
                    testHeader.appendChild(th);
                });
                
                // Veri satırlarını oluştur
                const testBody = document.getElementById('historyTestDataBody{{ loop.index }}');
                if (!testBody) {
                    console.error("historyTestDataBody{{ loop.index }} elementi bulunamadı");
                    return;
                }
                
                testData.forEach(function(item) {
                    const row = document.createElement('tr');
                    testKeys.forEach(function(key) {
                        const td = document.createElement('td');
                        td.textContent = item[key];
                        row.appendChild(td);
                    });
                    testBody.appendChild(row);
                });
                console.log("Test verisi tablosu oluşturuldu");
            } else {
                const testBody = document.getElementById('historyTestDataBody{{ loop.index }}');
                if (testBody) {
                    testBody.innerHTML = '<tr><td colspan="100%" class="text-center">Veri bulunamadı veya boş</td></tr>';
                }
            }
        } catch (error) {
            console.error('Test verisi işlenirken genel hata:', error);
            const testBody = document.getElementById('historyTestDataBody{{ loop.index }}');
            if (testBody) {
                testBody.innerHTML = '<tr><td colspan="100%" class="text-center">Veri yüklenirken hata oluştu: ' + error.message + '</td></tr>';
            }
        }
    });
    </script>
    {% endfor %}
{% endif %}

<!-- Model Düzenleme Modalı -->
<div class="modal fade" id="editModelModal" tabindex="-1" aria-labelledby="editModelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editModelModalLabel"><i class="bi bi-pencil-square me-2"></i>Model Adını Düzenle</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <form id="editModelForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_model_name" class="form-label">Eğitim Adı</label>
            <input type="text" class="form-control" id="edit_model_name" name="edit_model_name" required>
            <input type="hidden" id="edit_model_id" name="edit_model_id">
            <div class="form-text text-muted">
              <i class="bi bi-info-circle me-1"></i>Lütfen mevcut eğitimlerden farklı, benzersiz bir isim girin.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Loglar Modalı -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="logsModalLabel"><i class="bi bi-terminal-fill me-2"></i>Eğitim Logları</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body bg-dark">
        <div id="logsContent" class="text-white" style="font-family: monospace; font-size: 0.85rem;">
          <!-- Loglar burada gösterilecek -->
          <div class="text-center py-4">
            <div class="spinner-border text-light" role="status">
              <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-3 text-light">Loglar yükleniyor...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-dark border-secondary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<script>
  function openEditModal(modelId, modelName) {
    document.getElementById('edit_model_id').value = modelId;
    document.getElementById('edit_model_name').value = modelName;
    
    // Form gönderim URL'sini ayarla
    document.getElementById('editModelForm').action = '/edit_model/' + modelId;
    
    // Modal'ı aç
    new bootstrap.Modal(document.getElementById('editModelModal')).show();
  }
  
  function openLogsModal(modelId) {
    // Logları temizle ve yükleniyor göster
    document.getElementById('logsContent').innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p class="mt-3 text-light">Loglar yükleniyor...</p>
      </div>
    `;
    
    // Modal'ı aç
    const logsModal = new bootstrap.Modal(document.getElementById('logsModal'));
    logsModal.show();
    
    // Log verilerini almak için AJAX isteği gönder
    fetch('/get_model_logs/' + modelId)
      .then(response => response.json())
      .then(data => {
        if (data.logs && data.logs.length > 0) {
          const logsHtml = data.logs.map(log => `<div class="py-1">${log}</div>`).join('');
          document.getElementById('logsContent').innerHTML = logsHtml;
        } else {
          document.getElementById('logsContent').innerHTML = '<div class="text-center py-4"><i class="bi bi-exclamation-triangle-fill fs-4 mb-3"></i><p>Bu model için log kaydı bulunamadı.</p></div>';
        }
      })
      .catch(error => {
        console.error('Log verileri alınırken hata oluştu:', error);
        document.getElementById('logsContent').innerHTML = '<div class="text-center py-4 text-danger"><i class="bi bi-exclamation-circle-fill fs-4 mb-3"></i><p>Loglar yüklenirken bir hata oluştu.</p></div>';
      });
  }
  
  // Tooltip'leri aktifleştir
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });

  function openModelDetailsModal(modelId) {
    // Modalı temizle ve yükleniyor göster
    document.getElementById('modelDetailsLoading').classList.remove('d-none');
    document.getElementById('modelDetailsError').classList.add('d-none');
    document.getElementById('modelDetailsContent').classList.add('d-none');
    
    // Modalı aç
    const modelDetailsModal = new bootstrap.Modal(document.getElementById('modelDetailsModal'));
    modelDetailsModal.show();
    
    // Model detaylarını almak için AJAX isteği gönder
    fetch('/get_model_details/' + modelId)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const modelInfo = data.model_info;
          
          // Genel bilgileri doldur
          document.getElementById('model-name').textContent = modelInfo.model_name;
          document.getElementById('model-type').textContent = modelInfo.model_type_display;
          document.getElementById('dataset-name').textContent = modelInfo.dataset_name;
          document.getElementById('trained-at').textContent = modelInfo.trained_at;
          document.getElementById('model-file-name').textContent = modelInfo.training_info.model_file_path.split('/').pop() || 'Bilinmiyor';
          document.getElementById('dataset-hash').textContent = modelInfo.dataset_info.dataset_hash || 'Bulunamadı';
          
          // Veri dağılımı bilgilerini doldur
          document.getElementById('dataset-size').textContent = modelInfo.training_info.dataset_size || 'Bilinmiyor';
          document.getElementById('train-count').textContent = modelInfo.sample_info.train_samples_count || 'Bilinmiyor';
          document.getElementById('test-count').textContent = modelInfo.sample_info.test_samples_count || 'Bilinmiyor';
          document.getElementById('train-test-ratio').textContent = modelInfo.sample_info.train_test_ratio || 'Bilinmiyor';
          
          // Performans metriklerini doldur
          document.getElementById('metric-accuracy').textContent = modelInfo.metrics.accuracy.toFixed(2) + '%';
          document.getElementById('metric-precision').textContent = modelInfo.metrics.precision.toFixed(2) + '%';
          document.getElementById('metric-recall').textContent = modelInfo.metrics.recall.toFixed(2) + '%';
          document.getElementById('metric-f1').textContent = modelInfo.metrics.f1_score.toFixed(2) + '%';
          document.getElementById('metric-time').textContent = modelInfo.metrics.training_time.toFixed(2) + ' saniye';
          
          // Modele özgü kullanılan parametre değerlerini doldur
          const modelParamsContainer = document.getElementById('model-params-container');
          modelParamsContainer.innerHTML = '';
          
          if (Object.keys(modelInfo.model_params).length > 0) {
            const paramsTable = document.createElement('table');
            paramsTable.className = 'table table-sm table-striped';
            
            const paramsHeader = document.createElement('thead');
            paramsHeader.className = 'table-light';
            const paramsHeaderRow = document.createElement('tr');
            
            const headerParam = document.createElement('th');
            headerParam.textContent = 'Parametre';
            
            const headerValue = document.createElement('th');
            headerValue.textContent = 'Değer';
            
            const headerDesc = document.createElement('th');
            headerDesc.textContent = 'Açıklama';
            
            paramsHeaderRow.appendChild(headerParam);
            paramsHeaderRow.appendChild(headerValue);
            paramsHeaderRow.appendChild(headerDesc);
            paramsHeader.appendChild(paramsHeaderRow);
            paramsTable.appendChild(paramsHeader);
            
            const paramsBody = document.createElement('tbody');
            
            // Model parametrelerini göster
            Object.entries(modelInfo.model_params_display).forEach(([paramName, paramData]) => {
              // Eğitim/test split oranını ayrı kaydedeceğiz, burada atlama
              if (paramName === 'train_test_split') return;
              
              const row = document.createElement('tr');
              
              const paramCell = document.createElement('td');
              paramCell.className = 'fw-medium';
              paramCell.textContent = paramName;
              
              const valueCell = document.createElement('td');
              valueCell.className = 'text-dark';
              valueCell.textContent = paramData.display_value;
              
              const descCell = document.createElement('td');
              descCell.className = 'text-muted small';
              descCell.textContent = paramData.description;
              
              row.appendChild(paramCell);
              row.appendChild(valueCell);
              row.appendChild(descCell);
              paramsBody.appendChild(row);
            });
            
            // Eğitim veri yüzdesi satırını ekle
            const trainSplitValue = modelInfo.training_info.train_test_split || 80;
            const testSplitValue = 100 - trainSplitValue;
            
            // Eğitim veri yüzdesi satırı
            const trainSplitRow = document.createElement('tr');
            
            const trainSplitParamCell = document.createElement('td');
            trainSplitParamCell.className = 'fw-medium';
            trainSplitParamCell.textContent = 'Eğitim Veri Yüzdesi';
            
            const trainSplitValueCell = document.createElement('td');
            trainSplitValueCell.className = 'text-dark';
            trainSplitValueCell.textContent = trainSplitValue + '%';
            
            const trainSplitDescCell = document.createElement('td');
            trainSplitDescCell.className = 'text-muted small';
            trainSplitDescCell.textContent = 'Veri setinden eğitim için ayrılan yüzde';
            
            trainSplitRow.appendChild(trainSplitParamCell);
            trainSplitRow.appendChild(trainSplitValueCell);
            trainSplitRow.appendChild(trainSplitDescCell);
            paramsBody.appendChild(trainSplitRow);
            
            // Test veri yüzdesi satırı
            const testSplitRow = document.createElement('tr');
            
            const testSplitParamCell = document.createElement('td');
            testSplitParamCell.className = 'fw-medium';
            testSplitParamCell.textContent = 'Test Veri Yüzdesi';
            
            const testSplitValueCell = document.createElement('td');
            testSplitValueCell.className = 'text-dark';
            testSplitValueCell.textContent = testSplitValue + '%';
            
            const testSplitDescCell = document.createElement('td');
            testSplitDescCell.className = 'text-muted small';
            testSplitDescCell.textContent = 'Veri setinden test için ayrılan yüzde';
            
            testSplitRow.appendChild(testSplitParamCell);
            testSplitRow.appendChild(testSplitValueCell);
            testSplitRow.appendChild(testSplitDescCell);
            paramsBody.appendChild(testSplitRow);
            
            paramsTable.appendChild(paramsBody);
            modelParamsContainer.appendChild(paramsTable);
          } else {
            const noParamsDiv = document.createElement('div');
            noParamsDiv.className = 'alert alert-warning';
            noParamsDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i>Bu model için parametre bilgisi bulunamadı.';
            modelParamsContainer.appendChild(noParamsDiv);
          }
          
          // Model dosyası bilgilerini hazırla
          const fullPath = modelInfo.training_info.model_file_path || 'Bilinmiyor';
          const fileName = fullPath.split('/').pop() || 'Bilinmiyor';
          
          // Genel bilgilerde göster
          document.getElementById('model-file-name').textContent = fileName;
          
          // İçeriği göster, yükleniyor göstergesini gizle
          document.getElementById('modelDetailsLoading').classList.add('d-none');
          document.getElementById('modelDetailsContent').classList.remove('d-none');
        } else {
          throw new Error(data.error || 'Bilinmeyen bir hata oluştu');
        }
      })
      .catch(error => {
        console.error('Model detayları alınırken hata oluştu:', error);
        document.getElementById('modelDetailsLoading').classList.add('d-none');
        document.getElementById('modelDetailsError').classList.remove('d-none');
        document.getElementById('modelDetailsErrorMessage').textContent = 'Model bilgileri yüklenirken bir hata oluştu: ' + error.message;
      });
  }
  
  // Tooltip'leri aktifleştir
</script>

<!-- Model Detayları Modalı -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="modelDetailsModalLabel"><i class="bi bi-info-circle-fill me-2"></i>Model Detayları</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <!-- Yükleniyor göstergesi -->
        <div id="modelDetailsLoading" class="text-center py-4">
          <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
          </div>
          <p class="mt-3">Model bilgileri yükleniyor...</p>
        </div>
        
        <!-- Hata mesajı -->
        <div id="modelDetailsError" class="alert alert-danger d-none">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span id="modelDetailsErrorMessage">Model bilgileri yüklenirken bir hata oluştu.</span>
        </div>
        
        <!-- Model bilgileri içeriği -->
        <div id="modelDetailsContent" class="d-none">
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="model-info-card border rounded p-3 h-100">
                <h6 class="border-bottom pb-2 mb-3 text-primary"><i class="bi bi-card-list me-2"></i>Genel Bilgiler</h6>
                <table class="table table-sm">
                  <tr>
                    <th class="w-40">Model Adı:</th>
                    <td id="model-name" class="text-dark"></td>
                  </tr>
                  <tr>
                    <th>Model Tipi:</th>
                    <td id="model-type" class="text-dark"></td>
                  </tr>
                  <tr>
                    <th>Veri Seti:</th>
                    <td id="dataset-name" class="text-dark"></td>
                  </tr>
                  <tr>
                    <th>Veri Seti Hash:</th>
                    <td id="dataset-hash" class="text-dark text-break" style="word-wrap: break-word; max-width: 200px; font-family: monospace; font-size: 0.8rem;"></td>
                  </tr>
                  <tr>
                    <th>Model Dosyası:</th>
                    <td id="model-file-name" class="text-dark text-break" style="word-wrap: break-word; max-width: 200px;"></td>
                  </tr>
                                      <tr>
                      <th>Eğitim Tarihi:</th>
                      <td id="trained-at" class="text-dark"></td>
                    </tr>
                  </table>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="model-info-card border rounded p-3 h-100">
                <h6 class="border-bottom pb-2 mb-3 text-primary"><i class="bi bi-pie-chart-fill me-2"></i>Veri Dağılımı</h6>
                <table class="table table-sm">
                  <tr>
                    <th class="w-40">Veri Seti Boyutu:</th>
                    <td id="dataset-size" class="text-dark"></td>
                  </tr>
                  <tr>
                    <th>Eğitim Veri Sayısı:</th>
                    <td id="train-count" class="text-dark"></td>
                  </tr>
                  <tr>
                    <th>Test Veri Sayısı:</th>
                    <td id="test-count" class="text-dark"></td>
                  </tr>
                  <tr>
                    <th>Eğitim/Test Oranı:</th>
                    <td id="train-test-ratio" class="text-dark"></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
          
          <div class="row mb-4">
            <div class="col-12">
              <div class="model-info-card border rounded p-3">
                <h6 class="border-bottom pb-2 mb-3 text-primary"><i class="bi bi-bar-chart-fill me-2"></i>Performans Metrikleri</h6>
                <div class="row">
                  <div class="col-md-6">
                    <table class="table table-sm">
                      <tr>
                        <th class="w-40">Doğruluk (Accuracy):</th>
                        <td id="metric-accuracy" class="text-dark"></td>
                      </tr>
                      <tr>
                        <th>Kesinlik (Precision):</th>
                        <td id="metric-precision" class="text-dark"></td>
                      </tr>
                      <tr>
                        <th>Duyarlılık (Recall):</th>
                        <td id="metric-recall" class="text-dark"></td>
                      </tr>
                      <tr>
                        <th>F1 Skoru:</th>
                        <td id="metric-f1" class="text-dark"></td>
                      </tr>
                      <tr>
                        <th>Eğitim Süresi:</th>
                        <td id="metric-time" class="text-dark"></td>
                      </tr>
                    </table>
                  </div>
                  <div class="col-md-6">
                    <div class="metrics-info p-3 bg-light rounded">
                      <h6 class="mb-2 text-dark"><i class="bi bi-info-circle me-1"></i>Metrik Açıklamaları</h6>
                      <ul class="small text-muted mb-0 ps-3">
                        <li><strong>Doğruluk:</strong> Doğru tahmin edilen örneklerin tüm örneklere oranı</li>
                        <li><strong>Kesinlik:</strong> Phishing olarak tahmin edilenlerin gerçekten phishing olma oranı</li>
                        <li><strong>Duyarlılık:</strong> Gerçek phishing sitelerinin tespit edilme oranı</li>
                        <li><strong>F1 Skoru:</strong> Kesinlik ve duyarlılığın harmonik ortalaması</li>
                        <li><strong>Eğitim Süresi:</strong> Modelin eğitim süresi (saniye)</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-12">
              <div class="model-info-card border rounded p-3">
                <h6 class="border-bottom pb-2 mb-3 text-primary"><i class="bi bi-sliders me-2"></i>Model Ayarları</h6>
                <div id="model-params-container" class="table-responsive">
                  <!-- JavaScript ile doldurulacak tablo burada olacak -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>
{% endblock %} 